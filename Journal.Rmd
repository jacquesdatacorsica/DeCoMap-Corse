---
title: "Journal de recherche"
output:
  html_document:
    toc: true
    toc_float: true
    collapsed: false
    number_sections: false
    toc_depth: 1
    #code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set( warning = FALSE,  message = FALSE, cache.lazy = FALSE)
```

```{r, echo=FALSE,  cache=TRUE}
library(tidyverse)
library(banR)
library(jsonlite)
library(magrittr)
library(data.tree)
library(geosphere)
library(sf)
library(cartography)
library(stringr)
library(httr)
library(dplyr)
library(stringr)
library(DT)
data_dir <- 'data'
TED_destfile <-  str_c(data_dir, "/Export_OpenDataCAN_from2010to2019.csv")
DECP_destfile <-  str_c(data_dir, "/decp.json")

TED<- read.csv(TED_destfile)
df<-as.data.frame(fromJSON(DECP_destfile, flatten=TRUE)[['marches']])


BOAMP_2021<-readRDS("data/BOAMP_2021_df.Rda")
BOAMP_2020<-readRDS("data/BOAMP_2020_df.Rda")
BOAMP_2019<-readRDS("data/BOAMP_2019_df.Rda")
BOAMP_2018<-readRDS("data/BOAMP_2018_df.Rda")
BOAMP_2017<-readRDS("data/BOAMP_2017_df.Rda")
BOAMP_2016<-readRDS("data/BOAMP_2016_df.Rda")
BOAMP_2015<-readRDS("data/BOAMP_2015_df.Rda")
BOAMP<-rbind(BOAMP_2021,BOAMP_2020,BOAMP_2019,BOAMP_2018,BOAMP_2017,BOAMP_2016, BOAMP_2015)
rm(BOAMP_2021,BOAMP_2020,BOAMP_2019,BOAMP_2018,BOAMP_2017,BOAMP_2016,BOAMP_2015)

sirene_csv <- str_c(data_dir, '/', "StockEtablissement_utf8.csv")

base_sirene_global <- read_csv(sirene_csv)
base_sirene <- read_csv(
  sirene_csv,
  col_types = cols_only(
    siret = col_character(),
    codePostalEtablissement = col_character(),
    codeCedexEtablissement = col_character(),
    activitePrincipaleEtablissement = col_character(),
    enseigne1Etablissement = col_character()
  )
) %>%
  rename(sirene_code_postal=codePostalEtablissement)
rm(base_sirene_global)

# number of selected suppliers
nb_tit<-c()
for(i in 1:length(df$uid)){nb_tit[[i]]<-length(df$titulaires[[i]]$id)}
df$nb_tit<-nb_tit
# Creation of the multi-attribute table 
k<-1
uid<-c()
for(i in 1:length(df$uid)){for(j in 1:ifelse(df$nb_tit[[i]]==0,1,df$nb_tit[[i]])){uid[[k]]<-df$uid[[i]]; k<-k+1}}
tit<-c()
k<-1
for(i in 1:length(df$uid)){for(j in 1:ifelse(df$nb_tit[[i]]==0,1,df$nb_tit[[i]])){tit[[k]]<-df$titulaires[[i]]$id[j]; k<-k+1}}
df2<-data.frame()
df2<-as.data.frame(cbind(uid, tit))
df2$tit<-as.character(df2$tit)
df2$uid<-as.character(df2$uid)
# associate postal code and denomination to the SIRET of selected suppliers 
df2<-left_join(df2, base_sirene,by=c("tit"="siret"),keep=TRUE)
# join everything 
df<-left_join(df2,df, by="uid")
# Remove unnecessary databases
rm(df2,nb_tit,tit,uid)
```
---

> au fil de l'actualité
> de rapides enquêtes dans les bases de données
> des marchés publics

>  * Tender Electronic Daily

>  * Bulletin Officiel des Annonces des Marchés Publics

>  * Données Essentielles de la Commande Publique

---

# Enquête en bord de Beuvron

Quand on tombe au petit matin sur un papier comme celui-ci [Dons et services rendus : plongée dans les micropartis de Guillaume Peltier](https://www.lemonde.fr/societe/article/2021/06/01/dons-et-services-rendus-plongee-dans-les-micro-partis-de-guillaume-peltier_6082294_3224.html), qui nous apprend, au détour d'un paragraphe que 

> en 2017, Neung-sur-Beuvron paye 182 000 euros à Girard-Sudron 
> pour réaliser une étude « technico-économique » sur le remplacement
> de  l’éclairage public du village par des luminaires utilisant la technologie LED.

on se dit que la journée va être particulièrement excitante, que les données ouvertes des marchés publics vont révéler toute leur puissance, que des réseaux évoqués dans l'article transparaîtront rapidement des données brutes...

À 182 000 euros l'étude, on se dit qu'on n'est pas très loin des seuils européens et on commence donc naturellement par fouiller la TED pour voir un peu ce que la commune et la communauté de commune évoquée dans le papier ont passé comme marchés sur les dix dernières années. Question de ne pas passer à côté de dénominations fluctuantes, nous élargissons la recherche à tous les acheteurs dont le nom incoropore les termes "Sologne" et "Sudron".

```{r,  echo=TRUE,  cache=TRUE}

enquête<-TED[which(grepl("sologne", TED$CAE_NAME, ignore.case = TRUE)==TRUE |grepl("beuvron", TED$CAE_NAME, ignore.case = TRUE)==TRUE|grepl("neung", TED$CAE_NAME, ignore.case = TRUE)==TRUE),]
table<-enquête[,c(1,10,32,57)]
table%>%datatable(extensions = 'Buttons',
          options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                          lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))),rownames = FALSE)
```
Rien de concluant à l'échelles des marchés européens, rabattons-nous sur les marchés publiés au BOAMP sur la période mars 2015 à aujourd'hui.

```{r, echo=TRUE,  cache=TRUE}
enquête2<-BOAMP[which(grepl("sologne", BOAMP$denomination_ach, ignore.case = TRUE)==TRUE |grepl("beuvron", BOAMP$denomination_ach, ignore.case = TRUE)==TRUE |grepl("neung", BOAMP$ville_ach, ignore.case = TRUE)==TRUE),]
table2<-enquête2[,c(1,3,10,23)]
table2%>%datatable(extensions = 'Buttons',
          options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                          lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))),rownames = FALSE)

```

Pas grand chose de plus à se mettre sous la dent, et surtout, aucune nouvelle du marché indiqué dans l'article du Monde.

On se dit alors que les DECP (et même si elles ne couvrent pas la période incriminée) devraient permettre d'y voir plus clair dans les marchés passés dans cette ville ou cette interco. En requêtant de manière identique (sur les dénominations de l'acheteur), la pêche est un peu meilleure... 

```{r, echo=TRUE,  cache=TRUE}

enquête3<-df[which(grepl("sologne", df$acheteur.nom, ignore.case = TRUE)==TRUE |grepl("beuvron", df$acheteur.nom, ignore.case = TRUE)==TRUE |grepl("neung", df$acheteur.nom, ignore.case = TRUE)==TRUE),]
table3<-enquête3[,c(3,6,13,36)]
table3%>%datatable(extensions = 'Buttons',
          options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                          lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))),rownames = FALSE)
```
Mais à nouveau, rien de bien intéressant à se mettre sous la dent, même si la commune apparaît enfin dans nos fichiers. Et surtout, l'impression de ne pas avoir accès à l'ensemble des données.

En résumé, qu'est-ce que ce très rapide cas pratique nous enseigne ?

* que par nature, la base TED, compte-tenu des seuils élevés qu'elle implique, n'est pas d'une grande utilité pour connaître les pratiques d'achats principalement réalisés par les "petits" acheteurs.

* que la base BOAMP, parce qu'elle est impérative également uniquement au-dessus de seuils de passation élevés, ne s'avère pas très informative non plus

* que les DECP fonctionnent naturellement bien mieux, mais que d'une part, leur antériorité est limitée à des évènement très récents et que, d'autre part, comme la remontée des DECP sur data.gouv.fr n'est que parcellaire, 

* et surtout, qu' **un marché de 2017 à 182 000 euros passe totalement sous les radars**. Sans l'article de presse et les indiscrétions auxquelles les journalistes ont eu accès, aucune chance de tomber sur ce cas pourtant intéressant. C'est sans doute la principale information de cette rapide enquête ! 